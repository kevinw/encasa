<!doctype html>
<html>
<head>
  <meta charset="utf-8" /> 
  <title>&#x1f3e1; {{ todos_count }} TODOs</title>
  <base target="_parent">
  <link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet"> 
  <style>
    body {
      font-family: 'Oswald', sans-serif;
    }
    h1 {
      padding-left: 15px;
    }
    .unstyled-list {
      list-style: none;
    }
    input[type="checkbox"]:checked + label {
        text-decoration: line-through;
        color: grey;
    }
    .navigable-list li:focus-within {
      background-color: cyan;
    }
    /* .navigable-list :nth-child(odd) { background: #efefef; } */
    .todo-context, .todo-project {
      color: grey;
      text-decoration: none;
    }
    .last-updated {
      color: grey;
      font-size: 80%;
    }

    .due-date-outer.due-date-past {
      background: red;
      color: white;
      border-radius: 5px;
      padding-left: 4px;
      padding-right: 4px;
    }
    .due-date-outer.due-date-today { color: red; }
    .due-date-outer.due-date-future { color: grey; }
    .todo-done .due-date-outer { display: none; }

    .priority-label { font-size: 70%; color: grey; }
    .todo-priority-0 { font-size: 150%; }
    .todo-priority-1 { font-size: 120%; }
  </style>
</head>
<body>
  <h1><span id="total_todos_count">{{ todos_count }}</span> TODOs</h1>

  <ul class="unstyled-list navigable-list">
  {% for local_file in local_files %}
    <li{% if local_file.needs_update() %} class="needs-update"{% endif %}>
      <a class="navigable-elem" href="editlocal://{{ local_file.desc.path }}">{{ local_file.desc.path }}</a>
      <span class="last-updated">
        {% if local_file.needs_update() %}&#x2757; {% endif %}
        last updated {{ local_file.duration_since_modified()|humanize_duration }}
      </span>
    </li>
  {% endfor %}
  </ul>

  <ul id="todo_list" class="unstyled-list navigable-list">
  {% for todo in todos %}
      <li class="todo-priority-{{ todo.priority }}{% if todo.finished %} todo-done{% endif %}">
      <input class="navigable-elem" type="checkbox" id="todo-{{- loop.index0 }}" value="{{ todo.calc_hash() }}"{% if todo.finished %} checked{% endif %}>
      <label for="todo-{{- loop.index0 }}">
        <span class="priority-label">{{ todo.priority_label() }}</span>
        {{ todo.subject|linkify|spanify|safe }}
        {% match todo.due_date %}
        {% when Some with (due_date) %}
          <span class="due-date-outer due-date-{{ due_date|date_when_css_class }}">
            due <span class="due-date">{{ due_date|humanize_date }}</span>
          </span>
        {% when None %}
        {% endmatch %}
      </label>
    </li>
  {% endfor %}
  </ul>

  <!--
  <pre>{{ json_dump }}</pre>
  -->

<script>
function removeElement(array, elem) {
  var index = array.indexOf(elem);
  if (index > -1) {
    array.splice(index, 1);
  }
}

var activeRequests = [];

function postJSON(url, data, cb) {
  console.log("POST " + url + " " + JSON.stringify(data));
  function reqListener() {
    console.log(this.response);
  }
  var xhr = new XMLHttpRequest();
  xhr.addEventListener("load", reqListener);
  xhr.open("POST", "/todos");

  xhr.setRequestHeader('Content-Type', 'application/json');

  activeRequests.push(xhr);

  xhr.onreadystatechange = function() {
    if (this.readyState != 4)
      return;

    removeElement(activeRequests, xhr);

    if (this.status == 200) {
      if (cb) {
        var res = JSON.parse(this.responseText);
        cb(res);
      }
    } else {
      console.error(this.responseText);
      alert(this.responseText);
    }
  };

  xhr.send(JSON.stringify(data));
}

function markTodo(hash, completed, cb) {
  postJSON("/todos", { hash: hash, completed: completed }, cb);
}

function clickTodo(e) {
  var node = e.target;
  if (node.nodeName !== "INPUT")
    return;

  var hash = node.getAttribute("value");
  var markFinished = node.checked;
  markTodo(hash, markFinished, function(res) {
    if (res.hash) {
      node.value = res.hash;
    }
  });
}

function getFocusedElement() {
  if (document.hasFocus() &&
      document.activeElement !== document.body &&
      document.activeElement !== document.documentElement)
  {
      return document.activeElement;
  }
}

function mod(n, m) {
  return ((n % m) + m) % m;
}

function onKeyPress(event) {
  const keyName = event.key;
  switch (keyName) {
      case "j":
        navigateKeys(1);
        return false;
      case "k":
        navigateKeys(-1);
        return false;
      case "x":
        var elem = getFocusedElement();
        if (elem.nodeName == "INPUT") {
          elem.checked = !elem.checked;
          return false;
        }
        break;
      case "Enter":
        // If in a TODO list, enter follows the link.
        var elem = getFocusedElement();
        if (elem.nodeName == "INPUT") {
          var links = elem.parentElement.getElementsByTagName('a');
          if (links.length > 0) {
            links[0].click();
            return false;
          }
        }
        break;
  }
}

document.addEventListener("DOMContentLoaded", function() {
  var todoList = document.getElementById("todo_list");
  todoList.addEventListener("click", clickTodo, false);
  todoList.addEventListener("change", function(e) {
    if (e.target.checked) {
      e.target.parentElement.classList.add("todo-done");
    } else {
      e.target.parentElement.classList.remove("todo-done");
    }
  }, false);

  window.addEventListener("beforeunload", function (e) {
    if (activeRequests.length === 0)
      return;

    var confirmationMessage = "There are pending requests; are you sure you want to navigate away?";
    e.returnValue = confirmationMessage;     // Gecko, Trident, Chrome 34+
    return confirmationMessage;              // Gecko, WebKit, Chrome <34
  });

  document.addEventListener('keypress', onKeyPress);
});

function navigateKeys(delta) {
  var elem = getFocusedElement();
  var allNavigable = [].slice.call(document.getElementsByClassName("navigable-elem"));
  var index = allNavigable.indexOf(elem) + delta;
  if (index < -1)
    index = -1;
  allNavigable[mod(index,  allNavigable.length)].focus();
}

</script>

</body>
</html>
